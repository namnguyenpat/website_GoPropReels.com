---
import Layout from '../../layouts/Layout.astro';
import ReelCard from '../../components/ReelCard.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCollection } from 'astro:content';

// Fetch all coupons from the collection
const allCoupons = await getCollection('coupons');
const dealsData = allCoupons.map(c => c.data);

// Filter out expired deals
const today = new Date();
const activeDeals = dealsData.filter(deal => {
    if (!deal.expiration_date) return true;
    const expDate = new Date(deal.expiration_date);
    return expDate >= today;
}).sort((a, b) => {
    const dateA = new Date(a.created_at || 0);
    const dateB = new Date(b.created_at || 0);
    return dateB.getTime() - dateA.getTime(); 
});

const categories = ['all', ...new Set(activeDeals.map((deal) => deal.category))];
---

<Layout title="All Prop Firm Coupons & Discount Codes | GoPropReels" description="Browse all verified prop firm discount codes. Save on FTMO, Funding Pips, Apex and more. Verified daily.">
    <Header />
    
    <main class="min-h-screen bg-brand-bg pb-24">
        {/* Coupons Hero */}
        <div class="relative py-20 px-4 overflow-hidden border-b border-white/5 bg-white/5">
            <div class="absolute inset-0 bg-brand-accent/5 blur-3xl opacity-30"></div>
            <div class="max-w-4xl mx-auto text-center relative z-10">
                <div class="inline-flex items-center gap-2 rounded-full bg-brand-accent/10 border border-brand-accent/20 px-4 py-1.5 text-xs font-black uppercase text-brand-accent mb-8">
                    <i class="fa-solid fa-tag"></i>
                    Coupon Directory
                </div>
                <h1 class="text-5xl md:text-7xl font-black mb-6 tracking-tight text-white">
                    All <span class="text-brand-accent">Coupons</span>
                </h1>
                <p class="text-white/60 text-xl max-w-2xl mx-auto leading-relaxed">
                    The most comprehensive list of active prop firm discount codes. Verified daily by our team.
                </p>
            </div>
        </div>

        <div class="max-w-6xl mx-auto px-4 mt-16" id="feed">
            {/* Search and Category Filter Container */}
            <div class="mb-12 space-y-8">
                {/* Real-time Search */}
                <div class="max-w-xl mx-auto relative group">
                    <div class="absolute inset-y-0 left-5 flex items-center pointer-events-none">
                        <i class="fa-solid fa-magnifying-glass text-white/20 group-focus-within:text-brand-accent transition-colors"></i>
                    </div>
                    <input 
                        type="text" 
                        id="firm-search" 
                        placeholder="Search prop firms (e.g. FTMO, Apex...)" 
                        class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 pl-14 pr-6 text-white placeholder:text-white/20 outline-none focus:border-brand-accent/50 focus:bg-white/[0.08] transition-all shadow-xl"
                    />
                </div>

                {/* Category Filter */}
                <div class="flex flex-wrap justify-center gap-3">
                    {categories.map((cat) => (
                        <button
                            class="rounded-full border border-white/10 bg-white/5 px-6 py-2.5 text-xs font-black uppercase tracking-widest text-white transition-all hover:bg-white/10 data-[active=true]:border-brand-accent data-[active=true]:bg-brand-accent data-[active=true]:text-black shadow-lg"
                            data-filter={cat}
                            data-active={cat === 'all' ? 'true' : 'false'}
                        >
                            {cat}
                        </button>
                    ))}
                </div>
            </div>


            <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3" id="reel-grid">
                {activeDeals.map((deal, index) => (
                    <ReelCard deal={deal} data-index={index} data-firm-name={deal.firm_name.toLowerCase()} />
                ))}
            </div>

            {/* Pagination Controls */}
            <div id="pagination-controls" class="mt-16 flex justify-center items-center gap-2">
                {/* Buttons will be injected by JavaScript */}
            </div>


            {activeDeals.length === 0 && (
                <div class="text-center py-24 bg-white/5 rounded-3xl border border-dashed border-white/10">
                    <p class="text-white/40">No coupons found. Check back soon!</p>
                </div>
            )}
        </div>
    </main>

    <Footer />

    <script is:inline>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('firm-search');
            const filters = document.querySelectorAll('[data-filter]');
            const grid = document.getElementById('reel-grid');
            const paginationContainer = document.getElementById('pagination-controls');
            const allCards = Array.from(document.querySelectorAll('#reel-grid > article'));
            
            let currentCategory = 'all';
            let searchQuery = '';
            let currentPage = 1;
            const itemsPerPage = 15;

            function updateDisplay() {
                // 1. Filter cards based on category and search
                const filteredCards = allCards.filter(card => {
                    const matchesCategory = currentCategory === 'all' || card.dataset.category === currentCategory;
                    const matchesSearch = card.dataset.firmName.toLowerCase().includes(searchQuery.toLowerCase());
                    return matchesCategory && matchesSearch;
                });


                // 2. Calculate pagination
                const totalPages = Math.ceil(filteredCards.length / itemsPerPage);
                if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;

                // 3. Update visibility
                allCards.forEach(card => card.classList.add('hidden'));
                filteredCards.slice(startIndex, endIndex).forEach(card => {
                    card.classList.remove('hidden');
                    card.style.animation = 'fadeIn 0.3s ease-out';
                });

                // 4. Update Pagination Buttons
                renderPagination(totalPages);

                // 5. Empty state
                const emptyState = document.querySelector('.text-center.py-24');
                if (filteredCards.length === 0) {
                    emptyState?.classList.remove('hidden');
                } else {
                    emptyState?.classList.add('hidden');
                }
            }

            function renderPagination(totalPages) {
                if (!paginationContainer) return;
                paginationContainer.innerHTML = '';
                
                if (totalPages <= 1) return;

                // Simple pagination buttons
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = `w-10 h-10 rounded-full border transition-all font-bold text-xs ${
                        currentPage === i 
                        ? 'bg-brand-accent border-brand-accent text-black' 
                        : 'bg-white/5 border-white/10 text-white hover:bg-white/10'
                    }`;
                    btn.addEventListener('click', () => {
                        currentPage = i;
                        updateDisplay();
                        document.getElementById('feed')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    });
                    paginationContainer.appendChild(btn);
                }
            }

            // Event Listeners
            searchInput?.addEventListener('input', (e) => {
                searchQuery = e.target.value;
                currentPage = 1; // Reset to page 1 on search
                updateDisplay();
            });

            filters.forEach((filterBtn) => {
                filterBtn.addEventListener('click', () => {
                    currentCategory = filterBtn.dataset.filter;
                    currentPage = 1;
                    
                    // Update UI active state
                    filters.forEach(btn => btn.setAttribute('data-active', String(btn === filterBtn)));
                    
                    updateDisplay();
                });
            });

            // Initial render
            updateDisplay();

            // Handle URL Parameters
            const params = new URLSearchParams(window.location.search);
            const categoryParam = params.get('category');
            if (categoryParam) {
                const btn = document.querySelector(`button[data-filter="${categoryParam}"]`);
                if (btn) btn.click();
            }
        });

    </script>
</Layout>

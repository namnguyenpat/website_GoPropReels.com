---
import Layout from '../../layouts/Layout.astro';
import DealCard from '../../components/DealCard.astro';
import LatestBlogs from '../../components/LatestBlogs.astro';
import Header from '../../components/Header.astro';
import DynamicPoster from '../../components/DynamicPoster.astro';
import { generateImageAltText, getRelatedDeals, generateBreadcrumbs } from '../../utils/seo';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
	const coupons = await getCollection('coupons');
	return coupons.map((entry) => ({
		params: { id: entry.data.id },
		props: { deal: entry.data },
	}));
}

const { deal } = Astro.props;

// Try to fetch rich content from Markdown (High Priority)
const blogPost = await getEntry('blog', deal.id);
const { Content } = blogPost ? await blogPost.render() : { Content: null };

// Auto-generate related deals for internal linking
const allCoupons = await getCollection('coupons');
const deals = allCoupons.map(c => c.data);
const similarDeals = getRelatedDeals(deal, deals, { sameCategory: true, maxResults: 3 });
// Auto-generate breadcrumbs
const breadcrumbs = generateBreadcrumbs(deal);
// Auto-generate SEO alt text
const imageAlt = generateImageAltText(deal, 'landing');

// Check for expiration
const today = new Date();
const expirationDate = deal.expiration_date ? new Date(deal.expiration_date) : null;
const isExpired = expirationDate && expirationDate < today;

const pageTitle = isExpired 
    ? `[EXPIRED] ${deal.firm_name} Coupon - Deal Ended | GoPropReels`
    : `${deal.firm_name} Coupon | GoPropReels`;

const pageDescription = isExpired
    ? `This deal for ${deal.firm_name} has expired. Check out active coupons and discounts for ${deal.category} prop firms on GoPropReels.`
    : `Claim ${deal.discount_highlight} at ${deal.firm_name}. Copy code ${deal.coupon_code} and head straight to checkout.`;

const accentColor = deal.theme_color || '#FF2D55';
const canonical = `/deals/${deal.id}`;
---

<Layout title={pageTitle} description={pageDescription} canonical={canonical}>
	{/* Structured Data for SEO - Product/Offer */}
	<script type="application/ld+json" set:html={JSON.stringify({
		"@context": "https://schema.org",
		"@type": "Product",
		"name": `${deal.firm_name} ${deal.discount_highlight}`,
		"description": deal.seo_content.replace(/<[^>]*>?/gm, ''),
        "image": `https://gopropreels.com/images/deals/${deal.id}.png`,
		"offers": {
			"@type": "Offer",
			"price": 0,
			"priceCurrency": "USD",
			"availability": isExpired ? "https://schema.org/Discontinued" : "https://schema.org/InStock",
			"url": `https://gopropreels.com${canonical}`,
            "priceValidUntil": deal.expiration_date || "2026-12-31",
            "hasMerchantReturnPolicy": {
                "@type": "MerchantReturnPolicy",
                "applicableCountry": "US",
                "returnPolicyCategory": "https://schema.org/MerchantReturnFiniteReturnWindow",
                "merchantReturnDays": 30,
                "returnMethod": "https://schema.org/ReturnByMail",
                "returnFees": "https://schema.org/FreeReturn"
            },
            "shippingDetails": {
                "@type": "OfferShippingDetails",
                "shippingRate": {
                    "@type": "MonetaryAmount",
                    "value": 0,
                    "currency": "USD"
                },
                "shippingDestination": {
                    "@type": "DefinedRegion",
                    "addressCountry": "US"
                },
                "deliveryTime": {
                    "@type": "ShippingDeliveryTime",
                    "handlingTime": {
                        "@type": "QuantitativeValue",
                        "minValue": 0,
                        "maxValue": 0,
                        "unitCode": "DAY"
                    },
                    "transitTime": {
                        "@type": "QuantitativeValue",
                        "minValue": 0,
                        "maxValue": 0,
                        "unitCode": "DAY"
                    }
                }
            }
		},
		"aggregateRating": {
			"@type": "AggregateRating",
			"ratingValue": 5,
			"reviewCount": 1
		},
        "review": {
            "@type": "Review",
            "reviewRating": {
              "@type": "Rating",
              "ratingValue": 5,
              "bestRating": 5
            },
            "author": {
              "@type": "Person",
              "name": "GoPropReels Editor"
            }
        },
		"category": deal.category,
		"brand": {
			"@type": "Brand",
			"name": deal.firm_name
		}
	})} />
	
	<Header />

	<main class="relative mx-auto flex max-w-5xl flex-col gap-12 px-4 py-16 text-white">
        {isExpired && (
            <div class="rounded-xl border border-red-500/50 bg-red-500/10 p-4 text-center text-red-200">
                <p class="font-bold text-lg">‚ö†Ô∏è This deal has expired</p>
                <p class="text-sm opacity-80">The offer below is no longer valid. Please check our <a href="/" class="underline hover:text-white">homepage</a> for the latest active deals.</p>
            </div>
        )}

		{/* Auto-generated breadcrumbs for internal linking */}
		<nav class="flex items-center gap-2 text-sm text-white/60" aria-label="Breadcrumb">
			{breadcrumbs.map((crumb, index) => (
				<>
					{index > 0 && <span>/</span>}
					<a href={crumb.url} class="hover:text-white transition">
						{crumb.label}
					</a>
				</>
			))}
		</nav>

		<header class="grid gap-8 rounded-3xl border border-white/10 bg-white/5 p-6 lg:grid-cols-[1.3fr,1fr]">
			<div class="relative overflow-hidden rounded-3xl border border-white/5">
				{deal.video_source?.type === 'youtube' && deal.video_source.id ? (
					<iframe
						class="h-full min-h-[420px] w-full"
						src={`https://www.youtube.com/embed/${deal.video_source.id}?playlist=${deal.video_source.id}&autoplay=1&mute=1&loop=1&controls=0&modestbranding=1`}
						title={deal.firm_name}
						frameborder="0"
						allow="autoplay; encrypted-media; picture-in-picture"
						loading="lazy"
					/>
				) : (
					<a href={`/go/${deal.id}`} target="_blank" class="block h-full w-full">
						<div class="poster-fallback group relative h-full w-full flex items-center justify-center bg-black/20">
              <img
                src={`/images/deals/${deal.id}.png`}
                alt={imageAlt}
                class="h-full w-full object-cover transition-opacity duration-300 group-hover:opacity-20"
                loading="lazy"
                data-deal-id={deal.id}
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
              />
              <div class="dynamic-fallback h-full w-full">
                <DynamicPoster 
                  firmName={deal.firm_name} 
                  discount={deal.discount_highlight} 
                  themeColor={accentColor} 
                  dealId={deal.id}
                  category={deal.category}
                  keyBenefit={deal.key_benefit}
                  logo={deal.firm_logo}
                />
              </div>
            </div>
					</a>
				)}
			</div>
			<div class="flex flex-col gap-5">
				<span class="w-fit rounded-full border border-white/10 bg-black/50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-white/70">
					{deal.category}
				</span>
				<div>
					<p class="text-sm font-medium text-brand-accent">Exclusive drop</p>
					<h1 class="text-3xl font-black">{deal.title || `Get ${deal.discount_highlight} at ${deal.firm_name}`}</h1>
					<p class="mt-2 text-white/70">
						{deal.description || `Claim your exclusive ${deal.discount_highlight} discount with code ${deal.coupon_code}. The most trusted way to secure your ${deal.firm_name} evaluation or instant account today.`}
					</p>

                    <div class="mt-8 relative overflow-hidden rounded-[2.5rem] border-2 border-dashed border-brand-accent/30 bg-white/[0.03] p-6 backdrop-blur-md">
                        {/* Shimmer Effect */}
                        <div class="absolute inset-0 -translate-x-full bg-gradient-to-r from-transparent via-white/5 to-transparent shimmer-slow pointer-events-none"></div>

                        {isExpired ? (
                            <div class="space-y-6">
                                <div class="flex flex-wrap items-center justify-between gap-4">
                                    <div class="flex items-center gap-2 rounded-full bg-red-500/10 border border-red-500/20 px-3 py-1 text-[10px] font-black uppercase text-red-400">
                                        <div class="h-1.5 w-1.5 rounded-full bg-red-500"></div>
                                        Deal Expired
                                    </div>
                                </div>
                                <a
                                    href="/"
                                    class="flex w-full items-center justify-center gap-3 rounded-2xl bg-white/10 px-6 py-4 text-sm font-black text-white transition hover:bg-white/20 active:scale-95"
                                >
                                    <i class="fa-solid fa-magnifying-glass opacity-50"></i>
                                    View Similar Deals
                                </a>
                            </div>
                        ) : (
                            <div class="space-y-6">
                                <div class="flex flex-wrap items-center justify-between gap-4">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2 rounded-full bg-green-500/10 border border-green-500/20 px-3 py-1 text-[10px] font-black uppercase text-green-400">
                                            <div class="h-1.5 w-1.5 rounded-full bg-green-500 animate-pulse"></div>
                                            Active & Verified
                                        </div>
                                        <div class="flex items-center gap-1.5 rounded-full bg-white/5 px-3 py-1 text-[10px] font-bold text-white/40">
                                            <i class="fa-solid fa-bolt text-brand-accent"></i>
                                            98% Success
                                        </div>
                                    </div>
                                    <div class="text-[10px] font-black uppercase tracking-widest text-white/30">
                                        Used 1,241 times today
                                    </div>
                                </div>

                                <button
                                    class="group/voucher relative flex w-full items-center justify-center gap-4 overflow-hidden rounded-2xl bg-gradient-to-br from-brand-accent via-brand-accent to-orange-400 px-6 py-6 text-xl font-black text-white shadow-[0_0_40px_rgba(255,45,85,0.3)] transition-all hover:scale-[1.03] hover:shadow-[0_0_60px_rgba(255,45,85,0.5)] active:scale-[0.97]"
                                    data-copy-code={deal.coupon_code}
                                    data-link={`/go/${deal.id}`}
                                >
                                    <span class="relative z-10 tracking-tight transition-transform group-hover/voucher:translate-x-[-4px]">
                                        GET THIS {deal.discount_highlight} DEAL
                                    </span>
                                    <div class="relative z-10 flex h-8 w-8 items-center justify-center rounded-full bg-white/20 backdrop-blur-md transition-transform group-hover/voucher:translate-x-4">
                                        <i class="fa-solid fa-arrow-right text-sm"></i>
                                    </div>
                                    <div class="absolute inset-0 -translate-x-full bg-gradient-to-r from-transparent via-white/30 to-transparent transition-transform duration-700 group-hover/voucher:translate-x-full"></div>
                                </button>
                                
                                <div class="flex items-center justify-center gap-4 border-t border-white/5 pt-4 text-[9px] font-black uppercase tracking-[0.2em] text-white/20">
                                    <span class="flex items-center gap-1.5"><i class="fa-solid fa-shield-halved"></i> 100% Safe</span>
                                    <span class="flex items-center gap-1.5"><i class="fa-solid fa-check-double"></i> Verified 2h ago</span>
                                </div>
                            </div>
                        )}
                    </div>

					{deal.features && deal.features.length > 0 && (
						<div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-3">
							{deal.features.map((feature) => (
								<div class="flex items-center gap-2.5 rounded-xl border border-white/5 bg-white/5 px-3 py-2.5 transition hover:bg-white/10">
									<div class="flex h-5 w-5 shrink-0 items-center justify-center rounded-full bg-brand-accent/20 text-brand-accent">
										<i class="fa-solid fa-check text-[10px]"></i>
									</div>
									<span class="text-xs font-bold text-white/90">{feature}</span>
								</div>
							))}
						</div>
					)}

				</div>
			</div>
		</header>

		<section class="grid gap-6 lg:grid-cols-[1.2fr,0.8fr]">
			<div class="space-y-6">
				<article class="relative overflow-hidden rounded-[2.5rem] border border-white/10 bg-[#0a0a0a] p-8 md:p-12 shadow-2xl">
                    <div class="prose prose-invert max-w-none prose-h3:text-2xl prose-h3:font-black prose-h3:tracking-tight prose-p:text-lg prose-p:leading-relaxed prose-p:text-white/70 prose-strong:text-brand-accent prose-li:text-white/60 space-y-8">
    					{Content ? <Content /> : <div set:html={deal.seo_content} />}
                    </div>

                    {/* Pro/Con Comparison Grid */}
                    <div class="mt-16 grid gap-6 md:grid-cols-2">
                        <div class="rounded-3xl bg-green-500/5 p-8 border border-green-500/10 transition-all hover:border-green-500/20">
                            <h3 class="mb-6 flex items-center gap-3 text-xl font-black text-white">
                                <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-green-500/20 text-green-400">
                                    <i class="fa-solid fa-plus"></i>
                                </div>
                                What we love
                            </h3>
                            <ul class="space-y-4 text-white/70">
                                <li class="flex gap-3"><i class="fa-solid fa-check text-green-400 mt-1"></i> Industry's easiest drawdown rules</li>
                                <li class="flex gap-3"><i class="fa-solid fa-check text-green-400 mt-1"></i> High legacy trust (Millions paid)</li>
                                <li class="flex gap-3"><i class="fa-solid fa-check text-green-400 mt-1"></i> Trade multiple accounts simultaneously</li>
                            </ul>
                        </div>
                        <div class="rounded-3xl bg-red-500/5 p-8 border border-red-500/10 transition-all hover:border-red-500/20">
                            <h3 class="mb-6 flex items-center gap-3 text-xl font-black text-white">
                                <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-red-500/20 text-red-400">
                                    <i class="fa-solid fa-minus"></i>
                                </div>
                                Considerations
                            </h3>
                            <ul class="space-y-4 text-white/70">
                                <li class="flex gap-3"><i class="fa-solid fa-xmark text-red-400 mt-1"></i> Trailing drawdown is always active</li>
                                <li class="flex gap-3"><i class="fa-solid fa-xmark text-red-400 mt-1"></i> Dashboard can feel a bit technical</li>
                            </ul>
                        </div>
                    </div>

                    {/* Final Verdict Box */}
                    <div class="mt-12 rounded-[2rem] bg-gradient-to-br from-brand-accent/20 to-transparent p-1 border border-brand-accent/30 overflow-hidden shadow-[0_0_50px_rgba(var(--accent-rgb),0.1)]">
                        <div class="rounded-[1.9rem] bg-[#0c0c0c] p-10">
                            <h3 class="text-3xl font-black text-white mb-4">The Verdict</h3>
                            <p class="text-xl text-white/80 leading-relaxed italic">
                                "If you're looking for the absolute best balance between speed, capital, and cost, the <strong>{deal.firm_name} {deal.discount_highlight}</strong> deal is an unbeatable entry point."
                            </p>
                            <div class="mt-8 flex items-center gap-4">
                                <div class="h-px flex-1 bg-white/10"></div>
                                <span class="text-[10px] font-black uppercase tracking-[0.3em] text-white/20">GoPropReels Intelligence Team</span>
                                <div class="h-px flex-1 bg-white/10"></div>
                            </div>
                        </div>
                    </div>
				</article>

				{/* Google AdSense - Post D∆∞·ªõi (In-Feed/Article) */}
				<div class="rounded-3xl border border-white/10 bg-white/5 p-4 overflow-hidden">
					<ins class="adsbygoogle"
						style="display:block"
						data-ad-client="ca-pub-6456170405994901"
						data-ad-slot="9646186541"
						data-ad-format="auto"
						data-full-width-responsive="true"></ins>
					<script is:inline>
						(adsbygoogle = window.adsbygoogle || []).push({});
					</script>
				</div>
			</div>


			<div class="space-y-6">
				<div class="rounded-3xl border border-white/10 bg-black/40 p-6">
					<h2 class="text-lg font-semibold mb-4">Deal quick facts</h2>
					<ul class="space-y-4 text-sm text-white/70">
						<li class="flex items-center justify-between border-b border-white/5 pb-3 last:border-0 last:pb-0">
							<span class="text-white">Discount</span>
							<span class="font-bold text-brand-accent">{deal.discount_highlight}</span>
						</li>
						<li class="flex items-center justify-between border-b border-white/5 pb-3 last:border-0 last:pb-0">
							<span class="text-white">Code</span>
							<span id="deal-code-display" class="font-mono font-bold bg-white/10 px-2 py-1 rounded text-white">****</span>
						</li>
						<li class="flex items-center justify-between border-b border-white/5 pb-3 last:border-0 last:pb-0">
							<span class="text-white">Brand</span>
							<a href={`/?q=${encodeURIComponent(deal.firm_name)}`} class="font-medium text-brand-accent hover:underline hover:text-white transition-colors">
								{deal.firm_name}
							</a>
						</li>
						<li class="flex items-center justify-between border-b border-white/5 pb-3 last:border-0 last:pb-0">
							<span class="text-white">Category</span>
							<a href={`/?category=${deal.category}`} class="capitalize font-medium text-brand-accent hover:underline hover:text-white transition-colors">
								{deal.category}
							</a>
						</li>
						<li class="flex items-center justify-between border-b border-white/5 pb-3 last:border-0 last:pb-0">
							<span class="text-white">Status</span>
                            {isExpired ? (
                                <span class="flex items-center gap-1.5 text-red-400 font-bold">
                                    <i class="fa-solid fa-circle-xmark text-xs"></i>
                                    Expired
                                </span>
                            ) : (
                                <span class="flex items-center gap-1.5 text-green-400">
                                    <i class="fa-solid fa-circle-check text-xs"></i>
                                    Active
                                </span>
                            )}
						</li>
                        {deal.expiration_date && (
                            <li class="flex items-center justify-between border-b border-white/5 pb-3 last:border-0 last:pb-0">
                                <span class="text-white">Ends</span>
                                <span class="text-white/80">{deal.expiration_date}</span>
                            </li>
                        )}
					</ul>
					
					<div class="mt-6 pt-6 border-t border-white/10">
                        {/* Button moved to header */}
					</div>
                    
                    <div class="mt-3 text-center">
                        <button 
                            id="report-issue-btn"
                            class="text-xs text-white/40 hover:text-white/80 underline transition-colors"
                            data-deal-id={deal.id}
                            data-firm-name={deal.firm_name}
                        >
                            Report Issue
                        </button>
                    </div>
				</div>


				
				{deal.video_source?.type === 'youtube' && deal.video_source.id && (
					<div class="rounded-3xl border border-white/10 bg-black/40 p-6" id="seo-image-container">
						<h2 class="text-lg font-semibold mb-4">Deal Poster</h2>
						<a href={`/go/${deal.id}`} target="_blank" class="block w-full">
							<img
								src={`/images/deals/${deal.id}.png`}
								alt={`${deal.firm_name} ${deal.discount_highlight} Poster`}
								class="w-full rounded-xl shadow-lg"
								loading="lazy"
								data-deal-id={deal.id}
								onerror="this.onerror=null;this.src=this.src.replace('.png','.jpg')"
							/>
						</a>
					</div>
				)}



				<div class="space-y-4">
					<h2 class="text-lg font-semibold px-2">Latest Insights</h2>
					<LatestBlogs />
				</div>

                {/* Mindset Check Widget */}
                <div class="rounded-3xl border border-brand-accent/20 bg-brand-accent/5 p-6 relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-brand-accent/10 rounded-full blur-2xl group-hover:bg-brand-accent/20 transition-colors"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-full bg-brand-accent/10 flex items-center justify-center text-brand-accent">
                                <i class="fa-solid fa-brain text-lg"></i>
                            </div>
                            <h3 class="font-bold text-white">Mindset Check</h3>
                        </div>
                        
                        <p class="text-sm text-white/80 mb-4 leading-relaxed">
                            Don't blow this account! 90% of traders fail due to psychology, not strategy.
                        </p>
                        
                        <a href="/blog/ultimate-funding-guide-2026" class="flex items-center justify-between bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl p-3 transition-colors group/link">
                            <span class="text-sm font-semibold text-brand-accent">Read "Funding Guide 2026"</span>
                            <i class="fa-solid fa-arrow-right text-xs text-white/40 group-hover/link:text-white transition-colors"></i>
                        </a>
                    </div>
                </div>
			</div>
		</section>

		<section class="rounded-3xl border border-white/10 bg-white/5 p-6">
			<h2 class="text-2xl font-bold">How to activate</h2>
			<div class="mt-4 grid gap-4 sm:grid-cols-3 text-sm text-white/70">
				<div class="rounded-2xl border border-white/10 bg-black/40 p-4">
					<p class="text-white font-semibold mb-1">1. Copy</p>
					<p>Tap the main button. We copy {deal.coupon_code} and open the checkout page.</p>
				</div>
				<div class="rounded-2xl border border-white/10 bg-black/40 p-4">
					<p class="text-white font-semibold mb-1">2. Pick account</p>
					<p>Select the evaluation / instant size that matches your strategy.</p>
				</div>
				<div class="rounded-2xl border border-white/10 bg-black/40 p-4">
					<p class="text-white font-semibold mb-1">3. Checkout</p>
					<p>Paste the code, confirm the discount, and lock the payout split.</p>
				</div>
			</div>
		</section>

        <section class="rounded-3xl border border-white/10 bg-white/5 p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Popular Comparisons</h2>
                <a href="/compare" class="text-sm text-brand-accent hover:underline">View All</a>
            </div>
            <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                {deals
                    .filter(d => d.firm_name !== deal.firm_name) // Exclude current firm
                    .sort(() => 0.5 - Math.random()) // Shuffle
                    .slice(0, 3) // Take top 3
                    .map(otherDeal => {
                        // Ensure consistent slug order (alphabetical or specific logic) to match [...slug].astro
                        // In [...slug].astro: firmA is from outer loop, firmB from inner loop (i < j)
                        // So firmA index < firmB index in the original deals array? 
                        // Actually [...slug].astro uses: firms = [...new Set(deals.map(d => d.firm_name))]
                        // And loops i=0..len, j=i+1..len. So firmA is always earlier in the unique list than firmB.
                        
                        const allFirms = [...new Set(deals.map(d => d.firm_name))];
                        const firmA = allFirms.indexOf(deal.firm_name) < allFirms.indexOf(otherDeal.firm_name) ? deal.firm_name : otherDeal.firm_name;
                        const firmB = allFirms.indexOf(deal.firm_name) < allFirms.indexOf(otherDeal.firm_name) ? otherDeal.firm_name : deal.firm_name;
                        
                        const slug = `${firmA.toLowerCase().replace(/\s+/g, '-')}-vs-${firmB.toLowerCase().replace(/\s+/g, '-')}`;
                        
                        return (
                            <a href={`/compare/${slug}`} class="flex items-center justify-between p-4 rounded-xl border border-white/10 bg-black/40 hover:bg-white/10 hover:border-brand-accent/50 transition-all group">
                                <span class="font-semibold text-sm">{firmA} <span class="text-white/40 mx-1">vs</span> {firmB}</span>
                                <i class="fa-solid fa-arrow-right text-xs text-white/20 group-hover:text-brand-accent transition-colors"></i>
                            </a>
                        );
                    })
                }
            </div>
        </section>

		{similarDeals.length > 0 && (
			<section class="rounded-3xl border border-white/10 bg-white/5 p-6">
				<h2 class="text-2xl font-bold mb-2">Similar {deal.category} prop firm deals</h2>
				<p class="text-sm text-white/60 mb-6">Explore more {deal.category} trading opportunities</p>
				<div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
					{similarDeals.map((similarDeal) => (
						<DealCard deal={similarDeal} />
					))}
				</div>
				<div class="mt-6 text-center">
					<a href={`/#feed?category=${deal.category}`} class="text-sm text-brand-accent hover:underline">
						View all {deal.category} deals ‚Üí
					</a>
				</div>
			</section>
		)}
	</main>

	<footer class="relative z-10 border-t border-white/10 bg-black/60 px-4 py-8 text-xs text-white/60 mt-16">
		<div class="mx-auto flex max-w-5xl flex-col gap-4">
			<p class="text-sm text-white">
				GoPropReels is an affiliate bridge experience. Deals are curated for research and marketing purposes only.
			</p>
			<p>
				Affiliate Disclosure: We may earn a commission if you buy through our links. Your price never changes.
			</p>
			<p class="text-white/50 italic">
				Promotional programs may change according to each fund's policies.
			</p>
			<p>¬© {new Date().getFullYear()} GoPropReels. All rights reserved.</p>
		</div>
	</footer>

	<div
		id="deal-copy-toast"
		class="pointer-events-none fixed inset-x-0 bottom-24 z-50 mx-auto w-fit rounded-full border border-white/10 bg-black/80 px-6 py-3 text-sm font-semibold text-white opacity-0 shadow-glow transition"
	>
		Code copied
	</div>

	<script is:inline>
		document.addEventListener('DOMContentLoaded', () => {
			const toast = document.getElementById('deal-copy-toast');
			const copyButton = document.querySelector('[data-copy-code]');
            const reportButton = document.getElementById('report-issue-btn');

			const showToast = (message) => {
				if (!toast) return;
				toast.textContent = message;
				toast.style.opacity = '1';
				clearTimeout(window.__toastTimeout);
				window.__toastTimeout = setTimeout(() => {
					toast.style.opacity = '0';
				}, 1800);
			};

			copyButton?.addEventListener('click', () => {
				const code = copyButton.dataset.copyCode;
				const link = copyButton.dataset.link;
				if (!code) return;

				// Reveal code in Quick Facts
				const codeDisplay = document.getElementById('deal-code-display');
				if (codeDisplay) codeDisplay.textContent = code;

				// Show global modal
				const event = new CustomEvent('open-code-modal', {
					detail: { code, link }
				});
				document.dispatchEvent(event);

				if (link) {
					setTimeout(() => {
						// Create a temporary link
						const a = document.createElement('a');
						a.href = link;
						a.target = '_blank';
						a.rel = 'noopener noreferrer';
						document.body.appendChild(a);

						// Simulate click with Ctrl (Windows) or Meta (Mac) to open in background tab
						const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
						const event = new MouseEvent('click', {
							view: window,
							bubbles: true,
							cancelable: true,
							ctrlKey: !isMac, // Ctrl on Windows/Linux
							metaKey: isMac   // Cmd on Mac
						});
						
						a.dispatchEvent(event);
						a.remove();
					}, 1500); // 1.5 second delay
				}
			});

            // Report Issue Logic
            reportButton?.addEventListener('click', async () => {
                if (reportButton.disabled) return;
                
                const originalText = reportButton.textContent;
                reportButton.disabled = true;
                reportButton.textContent = "Reporting...";
                
                const BOT_TOKEN = "8450720428:AAFPYgmXs2hxvJFZ0yPUoee8De3UUYw_7RY";
                const CHAT_ID = "905715849";
                const dealId = reportButton.dataset.dealId;
                const firmName = reportButton.dataset.firmName;
                
                const message = `üö® *REPORT ISSUE*\n\nüè¢ **Firm:** ${firmName}\nüÜî **ID:** \`${dealId}\`\n\nUser reported an issue with this deal. Please check it.`;
                
                try {
                    const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: CHAT_ID,
                            text: message,
                            parse_mode: "Markdown"
                        })
                    });
                    
                    if (response.ok) {
                        showToast("Report sent! Thank you.");
                        reportButton.textContent = "Reported";
                    } else {
                        showToast("Error sending report.");
                        reportButton.textContent = originalText;
                        reportButton.disabled = false;
                    }
                } catch (e) {
                    console.error(e);
                    showToast("Error sending report.");
                    reportButton.textContent = originalText;
                    reportButton.disabled = false;
                }
            });
		});
	</script>

	<style is:global>
		@keyframes shimmer {
			from { transform: translateX(-100%); }
			to { transform: translateX(100%); }
		}
		.shimmer-slow {
			animation: shimmer 8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
		}
	</style>
</Layout>

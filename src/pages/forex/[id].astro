---
import Layout from '../../layouts/Layout.astro';
import DealCard from '../../components/DealCard.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import LatestBlogs from '../../components/LatestBlogs.astro';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
	const coupons = await getCollection('coupons');
    // Filter for forex firms
    const forexCoupons = coupons.filter(c => c.data.category.toLowerCase() === 'forex');
    // Get unique firm IDs
    const uniqueFirms = [...new Set(forexCoupons.map(c => c.data.id))];
    
	return uniqueFirms.map((id) => {
        const deal = forexCoupons.find(c => c.data.id === id).data;
        return {
            params: { id: id },
            props: { deal: deal },
        };
    });
}

const { deal } = Astro.props;

// Fetch ALL deals for this firm in this category
const allCoupons = await getCollection('coupons');
const now = Date.now();
const firmDeals = allCoupons
    .filter(c => c.data.firm_name === deal.firm_name && c.data.category.toLowerCase() === 'forex' && new Date(c.data.expiry_date || '2099-12-31').getTime() > now)
    .map(c => c.data);

// Try to fetch rich content from Markdown
const blogPost = await getEntry('reviews', deal.id);
const { Content } = blogPost ? await blogPost.render() : { Content: null };

const pageTitle = `${deal.firm_name} Review & Coupons (Forex) | GoPropReels`;
const pageDescription = `Explore ${deal.firm_name} prop firm details, ratings, and exclusive ${deal.category} discount codes. Claim the best deals today.`;
---

<Layout title={pageTitle} description={pageDescription}>
    <Header />
    
    <main class="relative mx-auto flex max-w-5xl flex-col gap-12 px-4 py-16 text-white">
        {/* Breadcrumb */}
        <nav class="flex items-center gap-2 text-sm text-white/60" aria-label="Breadcrumb">
            <a href="/" class="hover:text-white transition">Home</a>
            <span>/</span>
            <a href="/?category=forex" class="hover:text-white transition">Forex Firms</a>
            <span>/</span>
            <span class="text-brand-accent">{deal.firm_name}</span>
        </nav>

        <header class="flex flex-col md:flex-row items-center gap-8 rounded-3xl border border-white/10 bg-white/5 p-8">
            <div class="h-32 w-32 shrink-0 overflow-hidden rounded-2xl bg-white/10 p-4">
                <img src={deal.firm_logo} alt={deal.firm_name} class="h-full w-full object-contain" />
            </div>
            <div class="text-center md:text-left">
                <div class="inline-flex items-center gap-2 rounded-full bg-brand-accent/10 border border-brand-accent/20 px-3 py-1 text-[10px] font-black uppercase text-brand-accent mb-4">
                    <i class="fa-solid fa-chart-line"></i>
                    Forex Trading Partner
                </div>
                <h1 class="text-4xl font-black mb-2">{deal.broker || deal.firm_name}</h1>
                <p class="text-white/60 text-lg max-w-2xl">{deal.description || `Comprehensive review and active coupons for ${deal.firm_name}.`}</p>
            </div>
        </header>

        <section class="grid gap-12 lg:grid-cols-[1.4fr,0.6fr]">
            <div class="space-y-12">
                {/* 1. Content Section */}
                <article class="prose prose-invert max-w-none">
                    <h2 class="text-3xl font-black mb-8 border-l-4 border-brand-accent pl-6">Firm Intel & Review</h2>
                    {Content ? <Content /> : <div set:html={deal.seo_content} />}
                </article>

                {/* 2. Technical Report: Pricing Matrix */}
                {deal.challenges && deal.challenges.length > 0 && (
                    <section class="rounded-3xl border border-white/10 bg-black/40 overflow-hidden">
                        <div class="bg-white/5 px-8 py-4 border-b border-white/10 flex items-center justify-between">
                            <h3 class="text-xl font-black uppercase tracking-wider">Pricing Matrix</h3>
                            <span class="text-[10px] font-bold text-brand-accent bg-brand-accent/10 px-2 py-0.5 rounded border border-brand-accent/20">LIVE DATA</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm border-collapse">
                                <thead>
                                    <tr class="text-white/40 uppercase text-[10px] bg-white/[0.02]">
                                        <th class="px-8 py-4 font-black">Challenge Name</th>
                                        <th class="px-8 py-4 font-black">Model</th>
                                        <th class="px-8 py-4 font-black">Account Size</th>
                                        <th class="px-8 py-4 font-black">Price</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-white/5">
                                    {deal.challenges.map((c: any) => (
                                        <tr class="hover:bg-white/[0.02] transition">
                                            <td class="px-8 py-4 font-bold">{c.name || 'Standard'}</td>
                                            <td class="px-8 py-4"><span class="capitalize px-2 py-0.5 rounded bg-white/5 border border-white/10 text-[10px]">{c.model || '2-Step'}</span></td>
                                            <td class="px-8 py-4 font-mono text-brand-accent">${parseInt(c.account_size).toLocaleString()}</td>
                                            <td class="px-8 py-4 font-bold text-green-400">${c.price}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </section>
                )}

                {/* 3. Execution Environment: Leverage & Commissions */}
                <div class="grid gap-8 sm:grid-cols-2">
                    {/* Detailed Leverage */}
                    <div class="rounded-3xl border border-white/5 bg-white/[0.02] p-6">
                        <div class="flex items-center gap-2 mb-6">
                            <i class="fa-solid fa-bolt-lightning text-brand-accent"></i>
                            <h3 class="text-lg font-black uppercase tracking-wider">Asset Leverage</h3>
                        </div>
                        <div class="space-y-3">
                            {deal.leverage_details ? Object.entries(deal.leverage_details).map(([asset, types]) => (
                                <div class="flex flex-col gap-1 pb-3 border-b border-white/5 last:border-0">
                                    <div class="text-[10px] font-black uppercase text-white/40">{asset}</div>
                                    <div class="flex gap-4">
                                        {Object.entries(types as any).map(([type, value]) => (
                                            <div class="flex gap-1.5 items-baseline">
                                                <span class="text-[9px] text-white/30 uppercase">{type}:</span>
                                                <span class="text-xs font-bold text-white">{value as string}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )) : (
                                <div class="text-sm text-white/60 italic">Detailed leverage maps being synchronized...</div>
                            )}
                        </div>
                    </div>

                    {/* Commissions Section */}
                    <div class="rounded-3xl border border-brand-accent/20 bg-brand-accent/5 p-6 shadow-glow-sm">
                        <div class="flex items-center gap-2 mb-6">
                            <i class="fa-solid fa-percent text-brand-accent"></i>
                            <h3 class="text-lg font-black uppercase tracking-wider">Execution Costs</h3>
                        </div>
                        <div class="space-y-4">
                            {deal.commissions && Object.keys(deal.commissions).length > 0 ? Object.entries(deal.commissions).map(([asset, desc]) => (
                                <div class="pb-3 border-b border-white/10 last:border-0 text-sm">
                                    <div class="text-[10px] font-black uppercase text-brand-accent mb-1">{asset}</div>
                                    <div class="text-white/80 leading-relaxed text-xs">{desc as string}</div>
                                </div>
                            )) : (
                                <div class="text-sm text-white/60 italic">Standard commissions apply. Check trading terminal for live spreads.</div>
                            )}
                        </div>
                    </div>
                </div>

                {/* 4. Risk & Regulatory: Consistency & Forbidden */}
                <div class="grid gap-8 sm:grid-cols-2">
                    {/* Consistency Rules */}
                    <div class="rounded-3xl border border-white/5 bg-white/[0.02] p-6">
                        <h3 class="text-lg font-black mb-4 uppercase tracking-wider text-white/40">Consistency Policy</h3>
                        <div class="space-y-4">
                            {deal.consistency_rules && Object.keys(deal.consistency_rules).length > 0 ? Object.entries(deal.consistency_rules).map(([title, desc]) => (
                                <div class="p-3 rounded-xl bg-black/20 border border-white/5">
                                    <div class="text-[10px] font-black uppercase text-brand-accent mb-1">{title}</div>
                                    <p class="text-[11px] text-white/60 leading-relaxed">{desc as string}</p>
                                </div>
                            )) : (
                                <p class="text-xs text-white/40 italic">No explicit consistency constraints reported for this model.</p>
                            )}
                        </div>
                    </div>

                    {/* Forbidden Strategies */}
                    <div class="rounded-3xl border border-red-500/20 bg-red-500/5 p-6">
                        <h3 class="text-lg font-black mb-4 uppercase tracking-wider text-red-400/60 text-center">Breach Conditions</h3>
                        <ul class="space-y-2">
                            {deal.forbidden_strategies?.map((strat: string) => (
                                <li class="flex items-start gap-2 text-[11px] text-white/60">
                                    <i class="fa-solid fa-triangle-exclamation text-red-500/50 mt-0.5"></i>
                                    {strat}
                                </li>
                            ))}
                            {(!deal.forbidden_strategies || deal.forbidden_strategies.length === 0) && (
                                <li class="text-[11px] text-white/40 italic">Check official dashboard for specific strategy limitations.</li>
                            )}
                        </ul>
                    </div>
                </div>

                {/* 5. Payout Policy Deep Dive */}
                <div class="rounded-3xl border border-white/10 bg-gradient-to-br from-brand-accent/5 to-transparent p-8">
                    <h3 class="text-2xl font-black mb-6 flex items-center gap-3">
                        <i class="fa-solid fa-money-bill-transfer text-brand-accent"></i>
                        Payout Infrastructure
                    </h3>
                    <div class="grid gap-8 md:grid-cols-2">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between pb-3 border-b border-white/5">
                                <div class="text-xs font-black uppercase text-white/40">Min Reward</div>
                                <div class="text-lg font-bold text-brand-accent">{deal.payout_policy?.minimum_payout || '1% of initial'}</div>
                            </div>
                            <div class="flex items-center justify-between pb-3 border-b border-white/5">
                                <div class="text-xs font-black uppercase text-white/40">Approval Time</div>
                                <div class="text-lg font-bold">{deal.payout_policy?.processing_time || '1-3 Working Days'}</div>
                            </div>
                            <div>
                                <div class="text-xs font-black uppercase text-white/40 mb-2">Withdrawal Methods</div>
                                <div class="flex flex-wrap gap-2 text-[10px] font-bold">
                                    {deal.payout_methods?.map((m: string) => (
                                        <span class="px-2 py-1 bg-white/5 border border-white/10 rounded">{m}</span>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div class="bg-black/20 p-6 rounded-2xl border border-white/5">
                            <div class="text-xs font-black uppercase text-brand-accent mb-4 underline decoration-brand-accent/30 decoration-2 underline-offset-4">Available Reward Cycles</div>
                            <ul class="space-y-3">
                                {deal.payout_policy?.payout_cycles?.map((cycle: string) => (
                                    <li class="flex items-start gap-3 text-xs text-white/70">
                                        <i class="fa-solid fa-circle-check text-green-500 mt-1"></i>
                                        {cycle}
                                    </li>
                                ))}
                                {(!deal.payout_policy?.payout_cycles || deal.payout_policy.payout_cycles.length === 0) && (
                                    <li class="text-xs text-white/40 italic">Standard bi-weekly cycles apply.</li>
                                )}
                            </ul>
                        </div>
                    </div>
                </div>

                {/* 6. Timeline */}
                {deal.timeline && deal.timeline.length > 0 && (
                    <section>
                        <h3 class="text-2xl font-black mb-8 uppercase tracking-widest text-white/20">Operational History</h3>
                        <div class="space-y-8 border-l border-white/10 ml-4 pl-8">
                            {deal.timeline.map((event: any) => (
                                <div class="relative">
                                    <div class="absolute -left-[41px] top-1 h-4 w-4 rounded-full bg-brand-accent border-4 border-black"></div>
                                    <div class="text-xs font-black text-brand-accent uppercase mb-1">{event.date}</div>
                                    <h4 class="text-lg font-bold mb-2">{event.event}</h4>
                                    <p class="text-sm text-white/60 leading-relaxed">{event.description}</p>
                                </div>
                            ))}
                        </div>
                    </section>
                )}

                {/* 7. Promotional Offers (Moved to bottom) */}
                <section id="promo" class="scroll-mt-12">
                    <div class="flex items-center gap-4 mb-8">
                        <div class="h-px flex-1 bg-white/10"></div>
                        <h3 class="text-xl font-black uppercase tracking-[0.2em] text-white/40">Verified Promotions</h3>
                        <div class="h-px flex-1 bg-white/10"></div>
                    </div>
                    <div class="grid gap-6 sm:grid-cols-2">
                        {firmDeals.map(d => (
                            <DealCard deal={d} />
                        ))}
                    </div>
                </section>
            </div>

            <aside class="space-y-8">
                {/* Visual Identity & CTA */}
                <div class="rounded-3xl border-2 border-brand-accent/30 bg-gradient-to-b from-brand-accent/10 to-transparent p-6 text-center">
                    <img src={deal.firm_logo} alt={deal.firm_name} class="mx-auto h-20 w-20 object-contain mb-6 drop-shadow-glow-sm" />
                    <h2 class="text-2xl font-black mb-4">Official {deal.firm_name} Site</h2>
                    <a href={deal.affiliate_link} target="_blank" class="block w-full rounded-xl bg-brand-accent py-4 font-black text-black hover:scale-105 transition shadow-glow active:scale-95">
                        OPEN EVALUATION <i class="fa-solid fa-arrow-up-right-from-square ml-2"></i>
                    </a>
                    <p class="mt-4 text-[10px] text-white/40 font-bold uppercase tracking-widest">Authorized Referral Link</p>
                </div>

                {/* Quick Info Box */}
                <div class="rounded-3xl border border-white/10 bg-black/40 p-6">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-circle-info text-brand-accent"></i>
                        Quick Summary
                    </h3>
                    <ul class="space-y-4 text-sm text-white/70">
                        <li class="flex items-center justify-between border-b border-white/5 pb-3">
                            <span class="text-white">Category</span>
                            <span class="font-bold text-brand-accent uppercase tracking-tighter">{deal.category}</span>
                        </li>
                        <li class="flex items-center justify-between border-b border-white/5 pb-3">
                            <span class="text-white">Founded</span>
                            <span class="font-bold text-white uppercase">{deal.founded || '2022'}</span>
                        </li>
                        <li class="flex items-center justify-between border-b border-white/5 pb-3">
                            <span class="text-white">Headquarters</span>
                            <span class="font-bold text-white text-right leading-tight max-w-[120px]">{deal.firm_rules?.origin || 'Global'}</span>
                        </li>
                        <li class="flex items-center justify-between border-b border-white/5 pb-3">
                            <span class="text-white">Audit Status</span>
                            <span class="text-green-400 font-black tracking-widest">PASSED</span>
                        </li>
                    </ul>
                </div>

                <div class="space-y-4">
					<h3 class="text-lg font-semibold px-2">Market Insights</h3>
					<LatestBlogs />
				</div>
            </aside>
        </section>

    </main>

    <Footer />
</Layout>

---
import { generateImageAltText } from '../utils/seo';
import DynamicPoster from './DynamicPoster.astro';

interface VideoSource {
	type: 'image' | 'youtube';
	src?: string;
	id?: string;
}

interface Deal {
	id: string;
	firm_name: string;
	title: string;
	description: string;
	category: string;
	discount_highlight: string;
	coupon_code: string;
	theme_color: string;
	video_source: VideoSource;
	features: string[];
	affiliate_link: string;
	key_benefit?: string;
}

const { deal, ...rest } = Astro.props as { deal: Deal; [key: string]: any };
const accentColor = deal.theme_color || '#3B82F6';
const copyButtonId = `copy-${deal.id}`;

const initiallyHidden = rest['data-initially-hidden'] === 'true';
// Auto-generate SEO alt text
const imageAlt = generateImageAltText(deal, 'card');

const firmInitial = deal.firm_name.charAt(0);
const cardDescription = deal.description || "";
---

<article
	class={`group relative aspect-[9/16] w-full overflow-hidden rounded-[40px] border border-white/10 bg-black/40 backdrop-blur-md transition-all duration-500 hover:border-white/20 hover:scale-[1.02] active:scale-[0.98] ${initiallyHidden ? 'hidden' : ''}`}
	style={`--accent:${accentColor};`}
	data-category={deal.category}
	data-firm-name={deal.firm_name}
	{...rest}
>
    {/* Dynamic Background Poster */}
    <div class="absolute inset-0 z-0">
        <DynamicPoster 
            firmName={deal.firm_name}
            discount={deal.discount_highlight}
            themeColor={accentColor}
            variant="background"
            dealId={deal.id}
        />
    </div>

    {/* Overlays to make content readable on top of poster */}
    <div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] z-[1]"></div>
    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent z-[2]"></div>
    
    <div class="relative h-full flex flex-col p-8 z-10">
        {/* Top Header Row */}
        <div class="flex items-start justify-between mb-8">
            <div class="flex flex-col gap-1">
                <span class="inline-flex w-fit rounded-full bg-white/5 border border-white/10 px-3 py-1 text-[9px] font-black uppercase tracking-widest text-white/40">
                    {deal.category}
                </span>
            </div>
            <div class="flex gap-2">
			    <button 
				    id={`like-${deal.id}`}
				    class="like-btn flex h-10 w-10 items-center justify-center rounded-full bg-white/5 text-white/40 border border-white/10 transition hover:bg-brand-accent hover:text-white active:scale-95 group/heart"
				    data-deal-id={deal.id}
				    aria-label={`Like ${deal.firm_name} deal`}
				    onclick="event.stopPropagation();"
			    >
				    <i class="fa-regular fa-heart text-base group-hover/heart:fa-solid"></i>
			    </button>
			    <button 
				    id={`share-${deal.id}`}
				    class="share-btn flex h-10 w-10 items-center justify-center rounded-full bg-white/5 text-white/40 border border-white/10 transition hover:bg-white/20 active:scale-95"
				    data-deal-id={deal.id}
				    data-deal-url={`https://gopropreels.com/coupons/${deal.id}`}
				    data-deal-title={`${deal.firm_name} - ${deal.discount_highlight}`}
				    aria-label={`Share ${deal.firm_name} deal`}
				    onclick="event.stopPropagation();"
			    >
				    <i class="fa-solid fa-share-nodes text-base"></i>
			    </button>
            </div>
        </div>

        {/* Center Content: Firm Identity */}
        <div class="flex-1 flex flex-col items-center justify-center text-center">
            {/* Logo Wrapper */}
            <div class="relative mb-8">
                <div class="absolute -inset-4 bg-[var(--accent)] opacity-20 blur-2xl rounded-full animate-pulse"></div>
                <div 
                    class="relative flex h-24 w-24 items-center justify-center rounded-[32px] bg-gradient-to-br from-white/10 to-transparent border border-white/10 text-4xl font-black text-white shadow-2xl"
                    style={`border-color: ${accentColor}40;`}
                >
                    {deal.firm_logo ? (
                        <img 
                            src={deal.firm_logo} 
                            alt={deal.firm_name} 
                            class="h-14 w-14 object-contain" 
                            onerror={`window.handleLogoError(this, "${deal.firm_name}");`}
                        />

                    ) : (
                        firmInitial
                    )}

                </div>
            </div>

            <h3 class="text-3xl font-black text-white leading-none uppercase tracking-tighter mb-4">
                {deal.firm_name}
            </h3>

            <div 
                class="text-5xl font-black tracking-tighter mb-8"
                style={`color: ${accentColor};`}
            >
                {deal.discount_highlight}
            </div>

            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-green-500/10 border border-green-500/20">
                <i class="fa-solid fa-star text-[10px] text-green-500"></i>
                <span class="text-[10px] font-black uppercase tracking-widest text-green-500">
                    Trust Score: {deal.trust_score || '4.5'}
                </span>

            </div>
        </div>

        {/* Bottom Actions Area */}
        <div class="mt-8 pt-8 border-t border-white/5">


            <div class="flex items-center gap-2">
                <a 
                    href={`/coupons/${deal.id}`}
                    class="flex-1 rounded-2xl bg-white px-6 py-4 text-xs font-black text-black uppercase tracking-widest text-center transition hover:bg-brand-accent hover:text-white hover:scale-[1.05] active:scale-95"
                >
                    Get deal
                </a>
                <a 
                    href={`/coupons/${deal.id}`}
                    class="h-12 w-12 flex items-center justify-center rounded-2xl bg-white/5 border border-white/10 text-white transition hover:bg-white/10 active:scale-95"
                >
                    <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i>
                </a>
            </div>
        </div>
    </div>

    {/* Entire Card Link Wrapper */}
    <a href={`/coupons/${deal.id}`} class="absolute inset-0 z-[5]" aria-label={`View ${deal.firm_name} deal details`}></a>

    {/* Hover Accent Glow */}
    <div 
        class="absolute inset-x-0 bottom-0 h-1 transition-all duration-700 group-hover:h-full group-hover:bg-gradient-to-t group-hover:from-white/5 group-hover:to-transparent pointer-events-none z-0"
        style={`background-image: linear-gradient(to top, ${accentColor}10, transparent);`}
    ></div>
</article>


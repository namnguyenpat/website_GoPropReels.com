---
import { getCollection } from 'astro:content';

// Fetch all content at build time
const posts = await getCollection('blog');
const allCoupons = await getCollection('coupons');
const deals = allCoupons.map(c => c.data);

// Prepare the search index
const searchIndex = [
    // Add Firms (Funds)
    ...deals.map(deal => ({
        type: 'fund',
        title: deal.firm_name,
        description: deal.discount_highlight,
        url: `/coupons/${deal.id}`,
        image: null, 
        icon: 'fa-building-columns',
        date: new Date(deal.created_at || 0).valueOf() // Add date for sorting
    })),
    // Add Blog Posts (Insights)
    ...posts.map(post => ({
        type: 'insight',
        title: post.data.title,
        description: post.data.description,
        url: `/blog/${post.slug}`,
        image: post.data.heroImage || '/og-image.jpg',
        icon: 'fa-newspaper',
        date: post.data.pubDate.valueOf() // Add date for sorting
    }))
].sort((a, b) => b.date - a.date); // Sort newest first
---

<div id="search-modal" class="fixed inset-0 z-[100] bg-[#0f172a]/95 backdrop-blur-xl hidden opacity-0 transition-opacity duration-200" role="dialog" aria-modal="true">
    <div class="max-w-3xl mx-auto pt-24 px-4 h-full flex flex-col">
        
        {/* Search Header */}
        <div class="relative mb-8">
            <i class="fa-solid fa-magnifying-glass absolute left-6 top-1/2 -translate-y-1/2 text-white/40 text-xl"></i>
            <input 
                type="text" 
                id="search-input" 
                placeholder="Search Funds, Strategies, Psychology..." 
                class="w-full bg-white/5 border border-white/10 rounded-2xl py-6 pl-16 pr-16 text-xl text-white placeholder:text-white/20 focus:outline-none focus:border-brand-accent/50 focus:bg-white/10 transition-all"
                autocomplete="off"
            />
            <button id="close-search" class="absolute right-6 top-1/2 -translate-y-1/2 text-white/40 hover:text-white transition-colors">
                <span class="sr-only">Close</span>
                <kbd class="hidden md:inline-block px-2 py-1 bg-white/10 rounded text-xs font-mono">ESC</kbd>
                <i class="fa-solid fa-xmark md:hidden text-xl"></i>
            </button>
        </div>

        {/* Results Container */}
        <div id="search-results" class="flex-grow overflow-y-auto pb-20 space-y-8 custom-scrollbar hidden">
            
            {/* Funds Section */}
            <section id="results-funds" class="hidden">
                <h3 class="text-brand-accent font-bold text-sm uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-building-columns"></i> Funds
                </h3>
                <div class="grid gap-3" id="list-funds"></div>
            </section>

            {/* Insights Section */}
            <section id="results-insights" class="hidden">
                <h3 class="text-purple-400 font-bold text-sm uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-lightbulb"></i> Insights
                </h3>
                <div class="grid gap-3" id="list-insights"></div>
            </section>

            {/* Empty State */}
            <div id="no-results" class="text-center py-20 hidden">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white/5 mb-4">
                    <i class="fa-solid fa-ghost text-2xl text-white/20"></i>
                </div>
                <p class="text-white/40">No results found. Try a different keyword.</p>
            </div>

        </div>

        {/* Initial State (Suggestions) */}
        <div id="search-suggestions" class="flex-grow overflow-y-auto pb-20">
            <h3 class="text-white/40 font-bold text-sm uppercase tracking-wider mb-4">Popular Searches</h3>
            <div class="flex flex-wrap gap-2">
                <button class="suggestion-btn px-4 py-2 rounded-xl bg-white/5 border border-white/5 hover:border-brand-accent/30 hover:bg-white/10 transition-all text-white/70 text-sm">FTMO</button>
                <button class="suggestion-btn px-4 py-2 rounded-xl bg-white/5 border border-white/5 hover:border-brand-accent/30 hover:bg-white/10 transition-all text-white/70 text-sm">Trading Psychology</button>
                <button class="suggestion-btn px-4 py-2 rounded-xl bg-white/5 border border-white/5 hover:border-brand-accent/30 hover:bg-white/10 transition-all text-white/70 text-sm">Prop Firm Rules</button>
                <button class="suggestion-btn px-4 py-2 rounded-xl bg-white/5 border border-white/5 hover:border-brand-accent/30 hover:bg-white/10 transition-all text-white/70 text-sm">Funding Pips</button>
            </div>
        </div>

    </div>
</div>

<script define:vars={{ searchIndex }}>
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    const closeBtn = document.getElementById('close-search');
    const resultsContainer = document.getElementById('search-results');
    const suggestionsContainer = document.getElementById('search-suggestions');
    const listFunds = document.getElementById('list-funds');
    const listInsights = document.getElementById('list-insights');
    const sectionFunds = document.getElementById('results-funds');
    const sectionInsights = document.getElementById('results-insights');
    const noResults = document.getElementById('no-results');

    // Open/Close Logic
    window.openSearch = () => {
        modal.classList.remove('hidden');
        // Small delay to allow display:block to apply before opacity transition
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            input.focus();
        }, 10);
        document.body.classList.add('overflow-hidden');
    };

    window.closeSearch = () => {
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            input.value = '';
            renderResults([]); // Clear results
        }, 200);
        document.body.classList.remove('overflow-hidden');
    };

    closeBtn?.addEventListener('click', window.closeSearch);

    // Close on ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            window.closeSearch();
        }
        // Open on CMD+K / CTRL+K
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            window.openSearch();
        }
    });

    // Search Logic
    input?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        
        if (query.length === 0) {
            resultsContainer.classList.add('hidden');
            suggestionsContainer.classList.remove('hidden');
            return;
        }

        suggestionsContainer.classList.add('hidden');
        resultsContainer.classList.remove('hidden');

        const results = searchIndex.filter(item => 
            (item.title || '').toLowerCase().includes(query) || 
            (item.description || '').toLowerCase().includes(query)
        );

        renderResults(results);
    });

    // Suggestion Buttons
    document.querySelectorAll('.suggestion-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            input.value = btn.innerText;
            input.dispatchEvent(new Event('input'));
        });
    });

    function renderResults(results) {
        // Clear previous
        listFunds.innerHTML = '';
        listInsights.innerHTML = '';
        
        const funds = results.filter(r => r.type === 'fund');
        const insights = results.filter(r => r.type === 'insight');

        // Render Funds
        if (funds.length > 0) {
            sectionFunds.classList.remove('hidden');
            funds.forEach(item => {
                const el = document.createElement('a');
                el.href = item.url;
                el.className = 'flex items-center gap-4 p-4 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-brand-accent/30 transition-all group';
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-lg bg-brand-accent/10 flex items-center justify-center text-brand-accent">
                        <i class="fa-solid ${item.icon}"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white group-hover:text-brand-accent transition-colors">${item.title}</h4>
                        <p class="text-sm text-white/50 line-clamp-1">${item.description}</p>
                    </div>
                    <i class="fa-solid fa-chevron-right ml-auto text-white/20 group-hover:text-white transition-colors"></i>
                `;
                listFunds.appendChild(el);
            });
        } else {
            sectionFunds.classList.add('hidden');
        }

        // Render Insights
        if (insights.length > 0) {
            sectionInsights.classList.remove('hidden');
            insights.forEach(item => {
                const el = document.createElement('a');
                el.href = item.url;
                el.className = 'flex items-center gap-4 p-4 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-purple-400/30 transition-all group';
                el.innerHTML = `
                    <div class="w-12 h-12 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-400 flex-shrink-0">
                        <i class="fa-solid fa-lightbulb"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white group-hover:text-purple-400 transition-colors line-clamp-1">${item.title}</h4>
                        <p class="text-sm text-white/50 line-clamp-1">${item.description}</p>
                    </div>
                `;
                listInsights.appendChild(el);
            });
        } else {
            sectionInsights.classList.add('hidden');
        }

        // No Results
        if (funds.length === 0 && insights.length === 0) {
            noResults.classList.remove('hidden');
        } else {
            noResults.classList.add('hidden');
        }
    }
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }
</style>
